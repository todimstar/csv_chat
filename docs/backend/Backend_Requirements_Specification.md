# 后端需求规格说明书（Backend Requirements Specification）
版本：1.0
日期：2025-05-28
作者：产品经理 & 后端团队
状态：草稿

## 1. 文档修订记录
| 版本 | 日期       | 作者        | 描述     |
| ---- | ---------- | ----------- | -------- |
| 1.0  | 2025-05-28 | 产品经理    | 初始创建 |

## 2. 引言
### 2.1 文档目的
本说明书用于描述磁盘空间分析助手项目后端系统的功能需求和非功能需求，为后端开发、测试和维护提供指导。

### 2.2 项目概述
磁盘空间分析助手旨在通过 AI 技术分析 WizTree 导出的 CSV 数据，为用户提供文件组成、空间占用、清理建议等智能分析服务。本后端负责接收前端请求、处理 CSV 文件、与 AI 服务交互、持久化分析结果并返回给前端。

### 2.3 术语和缩略语
| 缩略语 | 全称                           |
| ------ | ------------------------------ |
| API    | Application Programming Interface |
| CSV    | Comma-Separated Values         |
| UUID   | Universally Unique Identifier |
| AI     | Artificial Intelligence       |

## 3. 业务需求
### 3.1 功能性需求
1. **文件上传**
   - 接收前端上传的 CSV 文件，验证文件格式和大小。
   - 支持同时处理多文件上传。
2. **异步分析任务**
   - 将上传的 CSV 文件转换为可处理的内部数据格式（如 Pandas DataFrame）。
   - 启动异步任务执行初步统计分析，并生成摘要。
   - 启动 AI 分析任务，生成清理建议或文件夹内容问答结果。
3. **结果查询**
   - 提供接口供前端查询分析任务状态（Pending/Processing/Completed/Failed）。
   - 提供接口获取分析摘要、清理建议和 AI 问答结果。
4. **文件夹内容 AI 问答**
   - 接收前端传入的 `folder_path` 和可选 `user_query`。
   - 基于已解析的文件列表和摘要，调用 AI 服务进行深度分析并返回回答。
5. **日志与审计**
   - 记录请求日志、任务执行日志和错误日志。
   - 提供接口或工具导出日志以供运维和安全审计。
6. **用户认证与权限（可选）**
   - 支持 API Key 或 JWT 认证，确保只有授权用户可访问接口。

### 3.2 非功能性需求
- **性能**：支持每秒至少 10 个文件上传请求，单个文件最大 50MB，处理延迟（包括 AI 分析）不超过 2 分钟。
- **可靠性**：分析任务必须采用异步设计，保证后端服务的高可用性。任务队列支持重试机制，失败后可人工或自动重试。
- **可扩展性**：后端服务应支持水平扩展，能够根据负载动态部署多实例。
- **安全性**：对上传文件和请求参数进行校验，防止注入攻击；对敏感配置（如 AI 服务密钥）采用环境变量管理。
- **可维护性**：代码遵循统一编码规范，提供完整注释；单元测试覆盖率不低于 80%。

### 3.3 约束
- 后端使用 Python 3.8+ 开发，采用 FastAPI 框架。
- 数据存储使用 PostgreSQL，异步队列使用 Redis + Celery。
- 部署环境为 Docker 容器，使用 Kubernetes 或 Docker Compose 进行编排。

## 4. 关键用例
### 用例 1：上传 CSV 文件进行分析
- **参与者**：前端用户
- **前置条件**：用户认证通过（如启用认证）。
- **触发事件**：调用 POST `/api/v1/upload` 接口上传 CSV。
- **基本流程**：
  1. 接收并验证 CSV 文件格式和大小。
  2. 将文件存储到对象存储或本地临时目录。
  3. 创建分析任务，返回 `analysis_id`。
  4. 异步执行统计分析和 AI 任务。
- **后置条件**：返回唯一任务 ID，前端通过该 ID 查询状态和结果。

### 用例 2：查询分析结果
- **参与者**：前端用户
- **触发事件**：调用 GET `/api/v1/analysis/{analysis_id}`。
- **基本流程**：
  1. 后端查询任务状态。
  2. 如果任务完成，返回分析摘要和建议；否则返回当前状态。

### 用例 3：文件夹内容 AI 问答
- **参与者**：前端用户
- **触发事件**：调用 POST `/api/v1/analysis/{analysis_id}/query`，传入 `folder_path` 和 `user_query`。
- **基本流程**：
  1. 验证任务存在且已完成前置统计分析。
  2. 在内部缓存或数据库中获取该分析的文件列表和摘要。
  3. 调用 AI 服务生成问答结果。
  4. 返回问答回答。

## 5. 接口需求概览
- POST `/api/v1/upload`
- GET `/api/v1/analysis/{analysis_id}`
- POST `/api/v1/analysis/{analysis_id}/query`
- GET `/api/v1/logs` （仅运维使用，可选）

（详细接口规范请参考《后端 API 文档》） 