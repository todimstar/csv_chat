# AI 磁盘空间分析助手

本项目旨在开发一款利用AI技术分析磁盘扫描数据（如WizTree导出的CSV文件），帮助用户理解文件组成、识别大文件/冗余文件、追踪文件增长趋势，并提供清理建议的智能工具。

## 项目目标

- 智能分析磁盘数据，轻松释放存储空间，洞察文件变化趋势。
- 提供超越传统工具的简单统计，提供更深层次的洞察和建议。
- 清晰展示文件/文件夹随时间的变化，帮助用户理解存储增长模式。
- 支持导入WizTree等流行磁盘扫描工具的CSV数据，降低用户使用门槛。
- 基于AI分析结果，提供针对性的文件清理建议，并能结合用户具体问题对特定文件夹内容进行解答。
- 优化了与AI交互的数据量，通过发送摘要信息来应对API的字数限制。
- **更灵活的CSV路径处理**：即使WizTree导出的CSV文件中没有直接的“Path”列，只要存在“文件名称”（或英文“File Name”）列，程序也能智能识别并将其作为路径信息进行分析，增强了对不同导出格式的兼容性。

## 如何开始

1.  **准备环境**:
    *   确保您的计算机上已安装 Python (建议版本 3.7+)。您可以从 [Python官网](https://www.python.org/downloads/) 下载并安装。
    *   如果您使用代码编辑器（如 VS Code），打开项目文件夹。

2.  **获取代码**:
    *   如果您通过 Git 克隆了仓库，请跳至下一步。
    *   如果直接下载了文件，请确保所有文件和文件夹结构完整。

3.  **创建虚拟环境 (推荐)**:
    *   打开终端或命令提示符，导航到项目根目录 (`Pycsstoai`)。
    *   运行以下命令创建虚拟环境 (例如，命名为 `.venv`):
        ```bash
        python -m venv .venv
        ```
    *   激活虚拟环境:
        *   Windows (CMD/PowerShell):
            ```bash
            .venv\Scripts\activate
            ```
        *   macOS/Linux (bash/zsh):
            ```bash
            source .venv/bin/activate
            ```

4.  **安装依赖**:
    *   在激活的虚拟环境中，运行以下命令安装所需的库:
        ```bash
        pip install -r requirements.txt
        ```

5.  **运行程序**:
    *   在项目根目录下，运行主程序:
        ```bash
        python src/main.py
        ```
    *   程序启动后，会弹出一个文件选择对话框，请选择一个 WizTree 导出的 CSV 文件进行分析。
    *   分析结果将打印在终端或命令提示符窗口中。

6.  **退出虚拟环境 (可选)**:
    *   当您完成操作后，可以在终端中输入以下命令退出虚拟环境:
        ```bash
        deactivate
        ```
7. **查看已安装的库**:
   * 在激活的虚拟环境中，运行以下命令查看所有已安装的Python库:
       ```bash
       pip list
       ```
   * 或者使用以下命令将已安装的库导出到文件:
       ```bash
       pip freeze > requirements.txt
       ```

## 使用方法

1.  **准备 WizTree CSV 文件**: 
    *   使用 WizTree 工具扫描您的磁盘。
    *   扫描完成后，通过 WizTree 的菜单导出数据为 CSV 文件 (通常在 “文件” -> “导出CSV文件...”)。
    *   请确保导出的 CSV 文件至少包含 **文件名称** (或英文 "File Name") 和 **大小** (或英文 "Size") 这两列信息。如果导出的文件有明确的 **路径** (或英文 "Path") 列，程序也会优先使用它。

2.  **运行程序**: 
    *   按照上面的“如何开始”步骤安装并运行程序 (`streamlit run src/app.py`)。
    *   程序启动后，会在浏览器中显示一个网页界面。

3.  **上传 CSV 文件**: 
    *   在网页界面上，点击 “选择 WizTree CSV 文件” 按钮，或者直接将您的 CSV 文件拖拽到指定区域。

4.  **查看分析结果**: 
    *   文件上传成功后，程序会自动进行分析，并在页面上展示各种统计数据、图表和 AI 的建议。
    *   您可以滚动页面查看所有分析内容。

5.  **与 AI 互动**: 
    *   在 “AI 分析特定文件夹内容” 部分，您可以输入 CSV 文件中存在的某个文件夹路径，并提出您关心的问题，然后点击按钮让 AI 进行分析和回答。

为了提供更友好的用户体验，本项目现在包含一个基于 Streamlit 的图形用户界面。

1.  **确保 Streamlit 已安装**: 如果您按照前面的步骤安装了 `requirements.txt` 中的依赖，Streamlit应该已经安装好了。
2.  **运行 Streamlit 应用**: 
    *   在激活的虚拟环境中，导航到项目根目录 (`Pycsstoai`)。
    *   运行以下命令:
        ```bash
        streamlit run src/app.py
        ```
    *   命令执行后，您的默认浏览器应该会自动打开一个新的标签页，显示应用的界面。如果没有自动打开，终端会显示一个本地网址 (通常是 `http://localhost:8501`)，您可以手动复制到浏览器中打开。
3.  **使用应用**: 
    *   通过界面上的“选择 WizTree CSV 文件”按钮上传您的 WizTree 导出的 CSV 文件。
    *   应用会自动分析文件并展示结果，包括基本统计、大文件列表、文件类型分析以及 AI 提供的建议。

## 主要功能特性

### AI 驱动的分析与建议

程序能够：

*   **智能解析CSV**：自动识别并处理WizTree导出的CSV文件，提取关键信息如文件名称、大小等。
    *   特别地，对于路径信息，程序会优先寻找名为“Path”的列。如果找不到，它会尝试使用名为“文件名称”或“File Name”的列作为路径来源。这使得即使用户导出的CSV格式稍有不同，程序也能大概率正确工作。
*   **基本统计展示**：清晰展示扫描项目总数、总占用空间等基础数据。
*   **识别大文件/文件夹**：快速定位占用空间最多的文件和文件夹。
*   **按类型/扩展名分类**：统计不同文件类型（如视频、图片、文档）和扩展名（如.mp4, .jpg, .docx）的空间占用情况，并以图表形式直观展示。
*   **AI摘要与清理建议**：利用AI大模型分析磁盘使用摘要，并根据大文件列表提供初步的文件清理建议。
*   **特定文件夹AI问答**：允许用户针对CSV中存在的特定文件夹路径提出问题，AI会结合该文件夹下的文件信息进行解答。

本项目现在包含一个初步的AI分析模块 (`src/ai_analyzer.py`)，用于对磁盘扫描结果进行更深层次的洞察。目前，该模块提供了以下占位符功能：

1.  **磁盘使用摘要分析 (`analyze_disk_usage_summary`)**: 
    当您想了解整个磁盘或某个较大范围的存储使用概览时，此功能非常有用。
    - **输入**: 磁盘使用摘要字符串 (例如："总大小: 100GB, 图片: 20GB (20%), 视频: 50GB (50%), 其他: 30GB (30%)")。
    - **AI处理**: AI会分析这个摘要，识别主要的空间占用类别，并给出通用的优化建议。
    - **输出**: AI生成的分析结果和优化建议。
2.  **文件清理建议 (`suggest_files_for_cleanup`)**: 
    如果您有一份文件列表（比如来自某个文件夹，或者整个磁盘的大文件列表），AI可以帮助您判断哪些文件可能适合清理。
    - **输入**: 一个包含文件信息的Pandas DataFrame (至少需要 'File Name', 'Size', 'Path' 列)。
    - **AI处理**: AI会查看文件列表的摘要（比如最大的几个文件），并根据这些信息给出清理建议，例如哪些类型的文件通常可以被归档或删除。
    - **输出**: AI生成的具体文件清理建议。
3.  **AI分析特定文件夹内容 (`analyze_folder_contents`)**:
    这是本次更新的重点功能！当您对某个特定文件夹里的文件感到困惑时（比如不知道这些文件是干什么的，是否重要，能不能删除），这个功能可以帮到您。
    - **输入**:
        - `folder_path`: 您想分析的文件夹的路径。
        - `file_details_df`: 一个包含该文件夹内详细文件信息的Pandas DataFrame (应有 'File Name', 'Size', 'Path', 'Type' 等列)。
        - `user_query` (可选): 您关于这个文件夹的具体问题。例如：“这个文件夹里的 .tmp 文件都是什么？” 或者 “哪些文件可以安全删除？”
    - **AI处理**:
        - 程序会首先生成该文件夹内容的摘要信息，包括主要文件类型统计、占用空间较大的文件示例等。
        - 然后，这个摘要连同您的具体问题（如果有的话）会一起发送给AI。
        - AI会基于这些信息，尝试回答您的问题，分析文件夹内容，并给出整理建议。
    - **输出**: AI针对您的文件夹和问题生成的分析和解答。

    **如何有效提问以获得更好的文件夹分析结果？**

    - **具体化您的问题**：与其问“这个文件夹能清理吗？”，不如问“这个文件夹里的 `*.log` 文件是做什么用的？我可以删除旧的日志文件吗？”
    - **提供上下文**：如果可能，在问题中提及文件夹的用途，例如：“这是我的'下载'文件夹，里面的这些大文件是什么？”
    - **理解AI的局限性**：AI的回答基于提供给它的文件摘要信息。它不能直接“看到”您的文件内容。对于非常关键或不确定的文件，AI通常会建议您谨慎操作或先备份。

    通过这种方式，即使我们不能把所有文件细节都发给AI，AI也能通过摘要和您的问题，给您提供有价值的帮助！

#### 如何在代码中使用

在 `src/main.py` 脚本中，`AIAnalyzer` 类被实例化并用于调用分析方法。分析结果会打印到控制台。

```python
# src/main.py (示例片段)
from src.ai_analyzer import AIAnalyzer

# ... (加载数据后)
if csv_data is not None and not csv_data.empty:
    analyzer = AIAnalyzer() # AIAnalyzer 会尝试从环境变量读取API密钥
    # 为AI分析准备摘要数据
    total_size_bytes = csv_data['Size'].sum()
    num_files = len(csv_data)
    summary_for_ai = f"总扫描项目数: {num_files}, 总占用空间: {format_size_dynamically(total_size_bytes)}."
    
    ai_summary_analysis = analyzer.analyze_disk_usage_summary(summary_for_ai)
    print("\n--- AI磁盘使用摘要分析 ---")
    print(ai_summary_analysis)

    ai_cleanup_suggestion = analyzer.suggest_files_for_cleanup(csv_data)
    print("\n--- AI文件清理建议 ---")
    print(ai_cleanup_suggestion)
```

**重要提示**: 当前的AI实现是基于占位符的，它模拟AI的响应。要获得真实的AI分析，您需要在 `src/ai_analyzer.py` 中集成实际的AI服务API调用（例如 OpenAI, Google Gemini, 或其他），并确保已正确配置API密钥（见下面的“AI 服务配置”部分）。

## 开发与调试建议

为了提高代码质量并减少常见错误，建议在开发过程中使用以下工具：

- **Linter (如 Flake8, Pylint)**: 帮助检查代码风格和潜在的语法错误。
- **Formatter (如 Black, autopep8)**: 自动格式化代码，保持风格一致性。

这些工具可以集成到您的开发环境中，在编码时实时提供反馈。

## 注意事项

*   **CSV 文件格式**: 
    *   程序主要针对 WizTree 导出的标准 CSV 格式进行了优化。请确保您的 CSV 文件包含可识别的列名，特别是关于文件路径（如 “文件名称”、“Path”）和文件大小（如 “大小”、“Size”）的列。
    *   如果程序提示找不到关键列（如 'Path'、'File Name' 或 'Size'），请检查您的 CSV 文件格式是否正确，或者列名是否与程序预期的有所不同。程序在无法找到 'Path' 列时，会尝试使用 'File Name' 列作为替代。
*   **AI API 密钥**: 
    *   AI 分析功能依赖于大语言模型服务。您需要在 `src/config.py` 文件中配置好您的 API 密钥，或者设置相应的环境变量。具体请参考 `src/config.py.example` 文件。
    *   如果未配置 API 密钥，AI 相关的功能将无法正常使用，但基础的磁盘数据统计和展示功能仍然可用。
*   **数据量与性能**: 
    *   处理非常大的 CSV 文件（例如包含数百万条目）可能会消耗较多时间和内存。程序在设计时已考虑优化，但极端情况下仍需耐心等待。
    *   AI 分析部分为了避免超出 API 的 token 限制，会选择性地发送数据摘要或部分数据（如最大的文件列表）给 AI。

## 故障排除

### Streamlit 应用启动时出现 `SyntaxError`

- **问题描述**: 应用无法启动，错误日志中提示 `SyntaxError`，例如 `SyntaxError: unterminated string literal`。
- **常见原因**: 这通常意味着代码中存在拼写错误，比如字符串的引号没有正确配对、括号不匹配等。
- **解决方法**: 
    1. 仔细阅读错误信息中指示的文件名和行号。
    2. 检查对应行及其附近的代码，查找是否有未闭合的字符串（如 `f"some string...` 后面缺少了 `"`）、括号或其他明显的语法问题。
    3. 修正错误后保存文件，然后尝试重新运行 Streamlit 应用。

- **CSV 文件导入与解析**:
    - 支持通过图形界面选择 WizTree 导出的 CSV 文件。
    - 尝试多种编码 (UTF-8, GBK, Latin1) 以提高文件兼容性。
    - **重要提示：** 程序设计为自动跳过 WizTree CSV文件的第一行（通常是WizTree的生成信息），直接从第二行开始读取数据和表头。请确保您的CSV文件符合此格式。
    - 请确保您的 CSV 文件从第二行开始包含有效的数据列，特别是用于分析大小的列（如 'Size' 或 '大小'）以及文件/文件夹名称 ('File Name') 和路径 ('Path') 信息。
- **基本数据统计**:
    - 显示扫描文件的总大小 (尝试基于WizTree CSV中根目录条目的大小进行计算，以避免重复统计，并动态显示单位如KB, MB, GB, TB)。
    - 显示扫描到的总文件/文件夹数量。
- **大文件/文件夹识别**:
    - 列出占用空间最大的 Top 10 条目 (可能是文件或文件夹，基于WizTree的输出)。
    - 显示每个条目的完整路径和大小 (动态显示单位如KB, MB, GB, TB)。
- **文件类型分析**:
    - 根据文件扩展名自动分类文件。
    - 预设分类包括：图片, 视频, 音频, 文档, 压缩包, 应用程序, 系统/缓存, 其他, 无扩展名/文件夹。
    - 统计每个分类下的文件总大小 (动态显示单位如KB, MB, GB, TB)、条目数量以及占总空间大小的百分比。
- **控制台输出**: 
    - 所有分析结果清晰地打印在控制台/终端窗口。
- **按类型或后缀名查询文件 (新增)**:
    - 能够根据文件分类（如“图片”、“视频”）或文件扩展名（如“jpg”、“exe”）查询并列出匹配的文件及其路径和大小。
    - **使用方法 (当前版本)**: 此功能已在 `src/main.py` 文件中的 `query_files_by_type_or_extension` 函数实现。开发者可以在 `main` 函数中取消注释并修改示例代码来调用此查询功能。例如，查询所有“视频”文件：`query_files_by_type_or_extension(csv_data, 'category', '视频')`；查询所有扩展名为 `exe` 的文件：`query_files_by_type_or_extension(csv_data, 'extension', 'exe')`。

## AI 服务配置

为了让AI分析功能真正运作（而不仅仅是显示模拟/占位符的回复），您需要配置AI服务。这主要通过编辑项目中的 `src/config.py` 文件来完成。

1.  **获取API密钥**：您需要从某个AI服务提供商那里获取一个API密钥。常见的提供商有OpenAI (提供GPT系列模型), Google (Gemini), Anthropic (Claude), SiliconFlow 等。具体获取方式请参考对应服务商的官方文档。

2.  **编辑配置文件**：打开 `src/config.py` 文件。您会看到类似下面的内容：
    ```python
    # src/config.py

    class AIConfig:
        def __init__(self):
            # AI服务配置
            self.api_key = None  # 在这里填入您的AI服务的API密钥
            self.api_endpoint = None  # 如果需要，填入AI服务的API端点
            self.model_name = "Qwen/Qwen3-8B"  # 默认使用的AI模型，您可以根据需要修改
            
            # 其他配置项
            self.max_tokens = 1000  # 每次请求的最大token数
            self.temperature = 0.7  # AI回复的创造性程度（0-1）
            
        # ... (其他方法)

    # 创建全局配置实例
    ai_config = AIConfig()
    ```
    您需要修改 `self.api_key` 的值为您获取到的API密钥。如果您的服务商提供了特定的API端点，也请相应修改 `self.api_endpoint`。您还可以根据需要调整 `self.model_name`、`self.max_tokens` 和 `self.temperature` 等参数。

    **示例：**
    ```python
    class AIConfig:
        def __init__(self):
            self.api_key = "sk-yourActualApiKeyHere12345"
            self.api_endpoint = "https://api.example.com/v1/chat/completions"
            self.model_name = "gpt-4-turbo"
            # ...
    ```

如果 `api_key` 未在 `src/config.py` 中配置，AI分析功能将返回提示信息，告知服务未配置。在这种情况下，程序可能使用**模拟/占位符**的AI响应（取决于具体实现），或者直接提示配置错误。这意味着您仍然可以看到功能如何工作，但得到的分析结果可能不是真实的AI分析。为了获得有意义的AI洞察，请确保正确配置API密钥。

## 文档

- [产品需求文档 (PRD)](./docs/PRD.md)
- [产品路线图 (Roadmap)](./docs/Roadmap.md)
- [用户故事地图 (User Story Map)](./docs/User_Story_Map.md)
- [产品评估指标框架 (Metrics Framework)](./docs/Metrics_Framework.md)

## 未来展望与可能的改进方向

*   **更智能的列名识别**：
    *   **当前**：程序主要依赖固定的中文（“文件名称”、“大小”、“路径”）和英文（“File Name”, “Size”, “Path”）列名，并在“Path”列缺失时尝试使用“文件名称”列。如果用户导出的CSV列名有细微差异（比如多了空格，或者使用了其他相近的词语），可能无法正确识别。
    *   **改进设想**：引入更灵活的列名匹配机制。例如，可以使用模糊匹配或正则表达式来识别可能代表文件路径、文件大小的列。或者，在列名不完全匹配时，给用户一个选择界面，让他们手动指定哪个CSV列对应哪个数据项（如“请选择代表文件路径的列：”）。
*   **交互式图表与筛选**：引入更高级的交互式图表库（如 Plotly Express, Bokeh），允许用户在图表上进行缩放、筛选、点击查看详情等操作。
*   **历史数据对比**：支持导入多次扫描的CSV文件，并对它们进行对比，分析文件和文件夹大小随时间的变化趋势。
*   **自定义清理规则**：允许用户设置自定义规则来识别冗余文件（例如，查找重复文件、特定时间范围内的临时文件等）。
*   **用户界面优化**：持续改进用户界面的美观性和易用性，提供更友好的用户体验，特别是对于不太懂技术的用户。
*   **更深入的AI集成**：探索更多AI应用场景，例如根据文件内容（如果可能获取摘要）进行分类、自动生成文件夹整理建议等。
*   **错误处理与用户引导**：当CSV文件格式不符合预期，或缺少关键信息时，提供更清晰、更具指导性的错误提示和解决建议，帮助用户快速定位并解决问题。

## 项目总结与展望 (V0.1)

### 当前状态总结

AI 磁盘空间分析助手 (Pycsstoai) 当前版本 (V0.1) 已经成功实现了以下核心功能：

1.  **CSV 数据导入与处理**：
    *   通过 `tkinter` 图形界面引导用户选择 WizTree 导出的 CSV 文件。
    *   支持多种文件编码 (UTF-8, GBK, Latin1) 以增强兼容性。
    *   自动跳过 WizTree CSV 文件的元数据行，直接读取数据。
    *   对列名进行标准化处理（例如，将 '文件名称' 统一为 'File Name'，'大小' 统一为 'Size'）。
    *   对 'Size' 列进行数值转换和空值处理。
2.  **核心数据分析**：
    *   计算并展示扫描的总文件/文件夹数量和总占用空间（动态格式化单位）。
    *   识别并列出占用空间最大的 Top N (默认为20) 个文件或文件夹，显示其路径和大小。
    *   **文件分类统计**：根据预设的类别（图片、视频、文档等）对文件进行归类，并统计每个类别的总大小、文件数量及占总空间的百分比。
    *   **文件扩展名统计**：统计不同文件扩展名的总大小，并列出 Top N (默认为20) 的扩展名及其占用空间。
    *   所有分析结果通过控制台清晰输出。
3.  **AI 分析集成 (初步)**：
    *   集成了 `AIAnalyzer` 类，能够接收分析结果的摘要信息，并（在配置真实AI服务后）调用AI进行磁盘使用摘要分析和文件清理建议。
    *   提供了通过 `src/config.py` 文件配置 AI 服务 API 密钥和模型参数的机制。
    *   目前若未配置真实AI服务，则使用占位符/模拟AI响应。
4.  **模块化设计**：
    *   代码结构清晰，主要逻辑分布在 `src/main.py` (主流程、数据分析)、`src/ai_analyzer.py` (AI分析逻辑) 和 `src/config.py` (配置管理)。
    *   定义了 `AnalysisResult` 类来结构化存储分析结果，便于传递和处理。

### 交互性现状与改进思考

**当前交互方式**：

*   **输入**：通过 `tkinter` 实现的简单文件对话框选择 CSV 文件。
*   **输出**：所有分析结果和 AI 建议均直接打印到命令行控制台。

这种方式对于开发者或有技术背景的用户是可行的，但对于普通用户（尤其是您提到的初中生用户）来说，交互性较弱，不够直观友好。

**交互性改进方向**：

为了提升用户体验，特别是让不熟悉代码的用户也能轻松使用，可以考虑以下几个方向来增强交互性：

1.  **图形用户界面 (GUI) 展示**：
    *   **方案一 (轻量级)**：扩展使用 `tkinter`，创建一个简单的主窗口来展示分析结果。例如，可以使用列表框、文本区域或者简单的图表（如条形图）来可视化显示最大的文件、文件类型分布等。
    *   **方案二 (更现代的GUI)**：考虑使用如 `PyQt` 或 `Kivy` 等更强大的GUI库，但这会增加项目的复杂度和依赖。
2.  **Web 应用界面**：
    *   **方案一 (简单快速)**：使用 `Streamlit` 或 `Flask` 快速搭建一个本地 Web 应用。用户在浏览器中上传 CSV 文件，分析结果以更丰富的形式（表格、图表、交互式元素）展示在网页上。这种方式跨平台性好，界面也更容易做得美观。
    *   **优势**：可以更容易地集成交互式图表库（如 Plotly, Bokeh），提供更动态的数据探索体验。
3.  **交互式命令行 (增强型)**：
    *   如果暂时不引入完整的GUI或Web界面，也可以考虑使用像 `rich` 或 `prompt_toolkit` 这样的库来美化命令行输出，增加颜色、表格、进度条等，并提供更友好的交互式查询选项。

**初步建议**：

考虑到用户的技术背景和快速实现友好界面的需求，**使用 `Streamlit` 构建一个简单的 Web 应用**可能是一个不错的选择。Streamlit 学习曲线相对平缓，能够快速将 Python 数据分析脚本转化为可交互的 Web 应用，非常适合展示数据和图表。

### 下一阶段规划 (V0.2 - 交互性提升)

基于以上思考，下一阶段 (V0.2) 的主要目标可以设定为：

1.  **引入交互式用户界面**：
    *   **核心任务**：选择一种方案（初步推荐 Streamlit）来实现图形化/Web化的用户界面。
    *   **界面功能**：
        *   允许用户通过界面上传 CSV 文件。
        *   清晰展示 `main.py` 中已有的各项分析结果（总览、大文件列表、分类统计、扩展名统计）。
        *   （可选）以图表形式（如饼图、条形图）可视化文件类型分布和扩展名分布。
        *   展示 AI 分析师的摘要和清理建议。
2.  **AI 功能完善与测试**：
    *   鼓励用户配置真实的 AI 服务 API 密钥，并测试 AI 分析功能的实际效果。
    *   根据测试结果，优化传递给 AI 的提示信息 (prompts)，以获得更准确、更有用的分析和建议。
3.  **错误处理与用户引导**：
    *   在界面中提供更友好的错误提示和操作指引。
4.  **文档更新**：
    *   更新 `README.md` 和其他相关文档，说明新界面的使用方法。

通过这些改进，AI 磁盘空间分析助手将变得更加易用和实用，特别是对于非技术用户。